@model BerechitChatGPT.Models.IndexModel

@Html.AntiForgeryToken()
<div class="d-flex flex-row h-100 pt-1 pb-1">

    <div class="d-flex flex-column h-100 w-100">
        <div class="section-head">
        </div>

        <div id="scroll-container" class="section-content">
            <div id="output-container" class="d-flex flex-column gap-1 p-1" style="height: 100%; overflow-y: auto;">
                <!-- Messages will be dynamically added here -->
            </div>
        </div>

        <div class="input-group mt-2">
            <textarea id="input" class="form-control" style="resize:none" rows="2" placeholder="Type your message..."></textarea>
            <button class="btn btn-primary input-control px-4" type="button" id="send" autocomplete="off">
                Send
                <i class="bi bi-caret-right-fill"></i>
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById("send").addEventListener("click", function () {
            var inputText = document.getElementById("input").value;
            var token = $('input[name="__RequestVerificationToken"]').val(); // Capture the anti-forgery token

            if (inputText.trim() === "") {
                alert("Please enter a message.");
                return;
            }

            // Create a new div for the user's message
            var userMessageDiv = document.createElement("div");
            userMessageDiv.className = "d-flex justify-content-end mb-2";
            userMessageDiv.innerHTML = `<div class="p-2 bg-primary text-white rounded" style="max-width: 70%; word-wrap: break-word;">${inputText}</div>`;
            document.getElementById("output-container").appendChild(userMessageDiv);

            // Clear the input field
            document.getElementById("input").value = "";

            $.ajax({
                url: '@Url.Action("SendMessage", "Home")',
                type: 'POST',
                data: {
                    userInput: inputText,
                    __RequestVerificationToken: token
                },
                success: function (response) {
                    if (response.success) {
                        // Create a new div for the server's response
                        var serverMessageDiv = document.createElement("div");
                        serverMessageDiv.className = "d-flex justify-content-start mb-2";
                        serverMessageDiv.innerHTML = `<div class="p-2 bg-secondary text-white rounded" style="max-width: 70%; word-wrap: break-word;">${response.message}</div>`;
                        document.getElementById("output-container").appendChild(serverMessageDiv);
                    } else {
                        alert("Failed to process the message.");
                    }

                    // Scroll to the bottom of the output-container
                    var scrollContainer = document.getElementById("scroll-container");
                    scrollContainer.scrollTop = scrollContainer.scrollHeight;
                },
                error: function () {
                    alert("Error sending message.");
                }
            });
        });
    </script>
}
